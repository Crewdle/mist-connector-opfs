!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var o in r)("object"==typeof exports?exports:e)[o]=r[o]}}(this,(()=>(()=>{"use strict";var e,t={d:(e,r)=>{for(var o in r)t.o(r,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},r={};t.r(r),t.d(r,{OPFSObjectStoreConnector:()=>o});class o{storeKey;root;constructor(e){this.storeKey=e}async get(e){const[t,r]=await this.getFolderHandle(e);for await(const o of t.values()){if("directory"===o.kind)throw new Error(`Cannot get file: ${e}`);{const e=await t.getFileHandle(r);return await e.getFile()}}throw new Error(`Cannot get file: ${e}`)}async list(t,r=!1){try{const o=[],[a,i,n]=await this.getFolderHandle(t),l="/"===t?a:await a.getDirectoryHandle(i);for await(const t of l.values()){const a="/"+(n.length>0?n.join("/"):""),i=a.length>1?a+"/"+t.name:"/"+t.name;if("directory"===t.kind)o.push({kind:e.Folder,name:t.name,path:a,pathName:i,entries:r?await this.list(i,r):[]});else{const r=await l.getFileHandle(t.name),n=await r.getFile();o.push({kind:e.File,name:t.name,type:n.type,size:n.size,path:a,pathName:i})}}return o}catch(e){throw new Error(`Cannot list directory: ${t}`)}}async getOrCreateFolderHandle(e){try{let t=await this.getRootFolderHandle();if(e){const r=a(e);for(const e of r)t=await t.getDirectoryHandle(e,{create:!0})}return t}catch(t){throw new Error(`Cannot get or create directory: ${e}`)}}async getRootFolderHandle(){if(this.root)return this.root;const e=await navigator.storage.getDirectory();return this.root=await e.getDirectoryHandle(this.storeKey,{create:!0}),this.root}async getFolderHandle(e){try{let t=await this.getRootFolderHandle();if("/"===e)return[t,"",[]];const r=a(e);for(const[e,o]of r.entries()){if(e===r.length-1)return[t,o,r];t=await t.getDirectoryHandle(o)}}catch(t){throw new Error(`Cannot get directory: ${e}`)}throw new Error(`Cannot get directory: ${e}`)}async writeFile(e,t){try{const r=await this.getOrCreateFolderHandle(t),o=await r.getFileHandle(e.name,{create:!0}),a=await o.createWritable();await a.write(e),await a.close()}catch(r){throw new Error(`Cannot write file: ${i(t??"/",e.name)}`)}}async deleteObject(t){const[r,o]=await this.getFolderHandle(t);for await(const a of r.values())if(a.name===o)try{return"directory"===a.kind?(await r.removeEntry(o,{recursive:!0}),e.Folder):(await r.removeEntry(o),e.File)}catch(e){throw new Error(`Cannot delete file: ${t}`)}throw new Error(`Cannot delete file: ${t}`)}async moveObject(t,r){try{const[o,a]=await this.getFolderHandle(t);for await(const i of o.values())if(i.name===a){if("directory"===i.kind)return await this.moveDirectory(o,t,r),e.Folder;{const i=await o.getFileHandle(a);return await this.moveFile(i,t,r),e.File}}throw new Error(`Cannot move object: ${t}`)}catch(e){throw new Error(`Cannot publish move operation: ${t}`)}}async calculateSize(t){const r=await this.list(t);let o=0;for(const t of r)t.kind===e.File?o+=t.size:o+=await this.calculateSize(t.pathName);return o}async moveFile(e,t,r){try{const o=await e.getFile(),a=r.split("/"),i=a.slice(-1),n=a.slice(0,a.length-1).join("/"),l=new File([o],i[0],{type:o.type});await this.writeFile(l,n),await this.deleteObject(t)}catch(e){throw new Error(`Cannot move file: ${t}`)}}async moveDirectory(e,t,r){try{await this.getOrCreateFolderHandle(r);const[o,i]=function(e){const t=a(e),r=t.pop()||"",o=t.join("/");return[0===o.length?"/":o,r]}(t),n=await e.getDirectoryHandle(i);await this.copyDirectory(n,t,r),await this.deleteObject(t)}catch(e){throw new Error(`Cannot move directory: ${t}`)}}async copyDirectory(t,r,o){const a=await this.list(r,!1);for(const r of a)if(r.kind===e.Folder)await this.moveDirectory(t,r.pathName,i(o,r.name));else{const e=await t.getFileHandle(r.name);await this.moveFile(e,r.pathName,i(o,r.name))}}}function a(e){return e.split("/").filter((e=>e.length>0))}function i(e,t){return"/"===e?e+t:e+"/"+t}return function(e){e.File="file",e.Folder="folder"}(e||(e={})),r})()));